{% extends "base.html" %}

{% block title %}ノート編集{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='note.css') }}">
{% endblock %}

{% block content %}
    <h1 class="text-xl mb-4">ノート編集</h1>

    <form action="/notes/{{ note.id }}/update" method="post">
        <div>
            <input 
                class="w-full bg-white border-1 border-solid px-1 py-2 mb-4"
                type="text"
                name="title"
                value="{{ note.title }}"
                required
            >
        </div>

        <div class="grid grid-cols-2 gap-4 h-[90vh] mb-2">
            <textarea
                class="w-full h-full resize-none overflow-auto
                bg-white font-mono border-1 border-solid px-1 py-2"
                id="editor"
                name="content_md"
                rows="20"
            >{{ note.content_md if note else '' }}</textarea>

            <div
                class="h-full overflow-auto rounded bg-white border p-4 markdown-body"
                id="preview"
            ></div>
        </div>

        <button class="bg-white shadow p-2 rounded" type="submit">更新</button>
    </form>

    <br>

    <a href="/notes/{{ note.id }}">キャンセル</a>
{% endblock %}

{% block markedjs %}
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js"></script>

    <script>
        const editor = document.getElementById("editor")
        const preview = document.getElementById("preview")

        function updatePreview() {
            const markdown = editor.value;
            
            // Markdown -> HTML
            const dirtyHtml = marked.parse(markdown);
            
            // HTMLをサニタイズ
            const cleanHtml = DOMPurify.sanitize(dirtyHtml);
            
            preview.innerHTML = cleanHtml;
        }

        editor.addEventListener("input", updatePreview)

        updatePreview();
    </script>
{% endblock %}

