{% extends "base.html" %}

{% block title %}新規ノート{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='note.css') }}">
{% endblock %}

{% block content %}
<h1 class="text-xl mb-4">新規ノート作成</h1>

<form action="{{ url_for('notes.create_note') }}" method="post">
  <div>
    <input
      class="w-full bg-white border-1 border-solid px-1 py-2 mb-4"
      type="text"
      name="title"
      placeholder="実験タイトル"
      required="required"
    />
  </div>

  <div class="grid grid-cols-2 gap-4 h-[90vh] mb-2">
    <textarea
      class="w-full h-[90vh] resize-none overflow-auto
      bg-white font-mono border-1 border-solid px-1 py-2"
      id="editor"
      name="content_md"
      rows="20"
      placeholder="Markdownで実験内容を記述してください"
    ></textarea>

    <div
      class="h-full overflow-auto rounded bg-white border p-4 markdown-body"
      id="preview"
    ></div>
  </div>

  <button class="bg-white shadow p-2 rounded" type="submit">保存</button>
</form>

<br>

<a href="{{ url_for('notes.notes_index') }}">一覧へ戻る</a>

{% endblock %}

{% block javascript %}
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>

    <!-- DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js"></script>

    <script>
      const editor = document.getElementById("editor")
      const preview = document.getElementById("preview")

      let isSyncingEditor = false;
      let isSyncingPreview = false;

      // ===== marked 設定 ===== 
      marked.setOptions({
          breaks: true,
          headerIds: false,
          mangle: false
      });

      // ===== 数式レンダリング =====
      function renderMath() {
          if (typeof renderMathInElement === "undefined") return;

          renderMathInElement(preview, {
          delimiters: [
              { left: "$$", right: "$$", display: true },
              { left: "$", right: "$", display: false }
          ],
          throwOnError: false
          });
      }

      function updatePreview() {
          const markdown = editor.value;

          const dirtyHtml = marked.parse(markdown);
          const cleanHtml = DOMPurify.sanitize(dirtyHtml);

          preview.innerHTML = cleanHtml;
          renderMath();
      }

      function syncEditorToPreview() {
          if (isSyncingPreview) return;
          
          isSyncingEditor = true;

          const editorMax = editor.scrollHeight - editor.clientHeight;
          const previewMax = preview.scrollHeight - preview.clientHeight;

          if (editorMax > 0 && previewMax > 0) {
              const ratio = editor.scrollTop / editorMax;
              preview.scrollTop = ratio * previewMax;
          }

          isSyncingEditor = false;
      }

      function syncPreviewToEditor() {
          if (isSyncingEditor) return;
          
          isSyncingPreview = true;

          const editorMax = editor.scrollHeight - editor.clientHeight;
          const previewMax = preview.scrollHeight - preview.clientHeight;

          if (editorMax > 0 && previewMax > 0) {
              const ratio = preview.scrollTop / previewMax;
              editor.scrollTop = ratio * editorMax;
          }

          isSyncingPreview = false;
      }

      editor.addEventListener("input", updatePreview);
      editor.addEventListener("scroll", syncEditorToPreview);
      preview.addEventListener("scroll", syncPreviewToEditor);
    </script>
{% endblock %}
